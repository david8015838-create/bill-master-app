<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>åœ˜é«”å¸³å‹™çµç®—å°ˆå®¶</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f8fafc; color: #1e293b; }
        .gradient-header { background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); }
        .glass-card { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="text/babel">
        const { useState, useMemo, useEffect } = React;

        const App = () => {
            const [step, setStep] = useState(1);
            const [participants, setParticipants] = useState([]);
            const [newName, setNewName] = useState('');
            const [expenses, setExpenses] = useState([]);
            const [selectedParticipants, setSelectedParticipants] = useState([]);

            useEffect(() => { if(window.lucide) lucide.createIcons(); }, [step, participants, expenses, selectedParticipants]);

            // --- æ ¸å¿ƒçµç®—å°ˆå®¶é‚è¼¯ ---
            const calculateSettlement = () => {
                if (participants.length === 0) return { balances: {}, plans: [], total: 0 };

                const netBalances = {};
                participants.forEach(p => netBalances[p.name] = 0);
                let totalExpense = 0;

                expenses.forEach(exp => {
                    totalExpense += exp.amount;
                    const count = exp.splitAmong.length;
                    const baseShare = Math.floor(exp.amount / count);
                    const remainder = exp.amount % count;

                    // ä»˜æ¬¾äººä»£å¢Šå¢åŠ æ·¨å€¼
                    netBalances[exp.payer] += exp.amount;

                    // åƒèˆ‡è€…æ‡‰è² æ“”æ¸›å°‘æ·¨å€¼
                    exp.splitAmong.forEach((name, index) => {
                        // é‚è¼¯è¦ç¯„ï¼šé¤˜æ•¸ç”±ä»˜æ¬¾äººå¸æ”¶ (æˆ–æ­¤è™•æ¡ç°¡å–®å‡åˆ†ï¼Œé¤˜æ•¸èª¿æ•´è‡³ç¬¬ä¸€ä½åƒèˆ‡è€…)
                        // ä¾æ“šæ‚¨çš„è¦æ±‚ï¼šé¤˜æ•¸è‡ªå‹•åˆ†é…çµ¦ä»˜æ¬¾äººï¼Œå³åƒèˆ‡è€…åªä»˜æ•´é™¤éƒ¨åˆ†
                        netBalances[name] -= baseShare;
                    });
                    
                    // é¤˜æ•¸ä¿®æ­£çµ¦ä»˜æ¬¾äºº (ä»˜æ¬¾äººæ‡‰è² æ“”éƒ¨åˆ†å¢åŠ )
                    netBalances[exp.payer] -= remainder;
                });

                // æ’®åˆæ¼”ç®—æ³•ï¼šå‚µå‹™æŠµéŠ·
                const debtors = [], creditors = [];
                Object.keys(netBalances).forEach(name => {
                    const bal = netBalances[name];
                    if (bal > 0.1) creditors.push({ name, amount: bal });
                    else if (bal < -0.1) debtors.push({ name, amount: Math.abs(bal) });
                });

                debtors.sort((a, b) => b.amount - a.amount);
                creditors.sort((a, b) => b.amount - a.amount);

                const plans = [];
                let d = 0, c = 0;
                while (d < debtors.length && c < creditors.length) {
                    const pay = Math.min(debtors[d].amount, creditors[c].amount);
                    if (pay > 0) {
                        plans.push({ from: debtors[d].name, to: creditors[c].name, amount: Math.round(pay) });
                        debtors[d].amount -= pay;
                        creditors[c].amount -= pay;
                    }
                    if (debtors[d].amount < 1) d++;
                    if (creditors[c].amount < 1) c++;
                }

                return { balances: netBalances, plans, total: totalExpense };
            };

            const report = useMemo(calculateSettlement, [participants, expenses]);

            return (
                <div className="min-h-screen pb-10">
                    <header className="gradient-header text-white py-8 px-6 shadow-2xl rounded-b-[3rem] mb-6">
                        <div className="max-w-md mx-auto flex items-center gap-4">
                            <div className="bg-blue-500 p-3 rounded-2xl shadow-lg"><i data-lucide="shield-check"></i></div>
                            <div>
                                <h1 className="text-2xl font-bold tracking-tight">å¸³å‹™çµç®—å°ˆå®¶</h1>
                                <p className="text-blue-300 text-xs">ç²¾ç¢ºã€å°ˆæ¥­ã€æœ€å„ªåŒ–é‚„æ¬¾æ–¹æ¡ˆ</p>
                            </div>
                        </div>
                    </header>

                    <main className="max-w-md mx-auto px-4 space-y-6">
                        {step === 1 && (
                            <div className="glass-card p-6 rounded-[2rem] shadow-xl space-y-4 border border-white">
                                <h2 className="text-lg font-bold flex items-center gap-2"><i data-lucide="users" className="w-5 h-5 text-blue-500"></i> æˆå“¡åå–®åˆå§‹åŒ–</h2>
                                <div className="flex gap-2">
                                    <input value={newName} onChange={e => setNewName(e.target.value)} onKeyPress={e => e.key === 'Enter' && (newName.trim() && setParticipants([...participants, {id: Date.now(), name: newName.trim()}], setNewName('')))} placeholder="è¼¸å…¥å¤¥ä¼´å§“å..." className="flex-1 bg-slate-100 border-none rounded-2xl px-5 py-4 outline-none focus:ring-2 focus:ring-blue-500" />
                                    <button onClick={() => {if(newName.trim()){setParticipants([...participants, {id: Date.now(), name: newName.trim()}]); setNewName('');}}} className="bg-blue-600 text-white px-6 rounded-2xl font-bold transition-all active:scale-90">æ–°å¢</button>
                                </div>
                                <div className="grid grid-cols-2 gap-2">
                                    {participants.map(p => (
                                        <div key={p.id} className="flex justify-between items-center p-3 bg-white rounded-xl border border-slate-100 shadow-sm">
                                            <span className="font-medium">{p.name}</span>
                                            <button onClick={() => setParticipants(participants.filter(x => x.id !== p.id))} className="text-slate-300 hover:text-red-500"><i data-lucide="trash-2" className="w-4 h-4"></i></button>
                                        </div>
                                    ))}
                                </div>
                                {participants.length >= 2 && <button onClick={() => {setStep(2); setSelectedParticipants(participants.map(p => p.name));}} className="w-full bg-slate-900 text-white py-5 rounded-3xl font-bold shadow-xl flex items-center justify-center gap-2">ä¸‹ä¸€æ­¥ï¼šè¼¸å…¥æ¶ˆè²» <i data-lucide="chevron-right"></i></button>}
                            </div>
                        )}

                        {step === 2 && (
                            <div className="space-y-4">
                                <div className="glass-card p-6 rounded-[2rem] shadow-xl border border-white space-y-4">
                                    <h2 className="text-lg font-bold flex items-center gap-2"><i data-lucide="receipt" className="w-5 h-5 text-blue-500"></i> æ¶ˆè²»é …ç›®è¼¸å…¥</h2>
                                    <input id="expName" placeholder="æ¶ˆè²»é …ç›® (ä¾‹å¦‚: æ™šé¤)" className="w-full bg-slate-100 border-none rounded-2xl px-5 py-4 outline-none" />
                                    <input id="expAmount" type="number" placeholder="æ¶ˆè²»é‡‘é¡" className="w-full bg-slate-100 border-none rounded-2xl px-5 py-4 outline-none" />
                                    
                                    <div className="space-y-2 text-sm">
                                        <p className="font-bold text-slate-500 ml-1">èª°ä»˜éŒ¢çš„ï¼Ÿ</p>
                                        <select id="expPayer" className="w-full bg-slate-100 border-none rounded-2xl px-5 py-4 outline-none appearance-none">
                                            {participants.map(p => <option key={p.id} value={p.name}>{p.name}</option>)}
                                        </select>
                                    </div>

                                    <div className="space-y-2 text-sm">
                                        <p className="font-bold text-slate-500 ml-1">å‹¾é¸åƒèˆ‡è€…ï¼š</p>
                                        <div className="grid grid-cols-2 gap-2">
                                            {participants.map(p => (
                                                <button key={p.id} onClick={() => selectedParticipants.includes(p.name) ? setSelectedParticipants(selectedParticipants.filter(n => n !== p.name)) : setSelectedParticipants([...selectedParticipants, p.name])} className={`p-3 rounded-2xl border text-sm font-bold transition-all ${selectedParticipants.includes(p.name) ? 'bg-blue-600 text-white border-blue-600 shadow-md' : 'bg-white text-slate-400 border-slate-200'}`}>
                                                    {p.name} {selectedParticipants.includes(p.name) ? 'âœ“' : ''}
                                                </button>
                                            ))}
                                        </div>
                                    </div>

                                    <button onClick={() => {
                                        const n = document.getElementById('expName'), a = document.getElementById('expAmount'), p = document.getElementById('expPayer');
                                        if (n.value && a.value && selectedParticipants.length > 0) {
                                            setExpenses([...expenses, { id: Date.now(), name: n.value, amount: parseInt(a.value), payer: p.value, splitAmong: [...selectedParticipants] }]);
                                            n.value = ''; a.value = '';
                                            setSelectedParticipants(participants.map(p => p.name));
                                        }
                                    }} className="w-full bg-blue-600 text-white py-4 rounded-2xl font-bold shadow-lg shadow-blue-200">+ æ–°å¢æ¶ˆè²»</button>
                                </div>
                                
                                <div className="space-y-2">
                                    {expenses.map(e => (
                                        <div key={e.id} className="bg-white p-4 rounded-2xl border border-slate-200 flex justify-between items-center shadow-sm">
                                            <div>
                                                <div className="font-bold text-slate-700">{e.name}</div>
                                                <div className="text-[10px] text-slate-400 uppercase font-black">{e.payer} æ”¯ä»˜ | {e.splitAmong.length} äººåƒèˆ‡</div>
                                            </div>
                                            <div className="text-lg font-black text-slate-900">${e.amount}</div>
                                        </div>
                                    ))}
                                </div>

                                {expenses.length > 0 && <button onClick={() => setStep(3)} className="w-full bg-slate-900 text-white py-5 rounded-3xl font-bold shadow-2xl flex items-center justify-center gap-2">ç”Ÿæˆå°ˆå®¶çµç®—å ±å‘Š <i data-lucide="file-text"></i></button>}
                            </div>
                        )}

                        {step === 3 && (
                            <div className="space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-700">
                                <div className="glass-card p-8 rounded-[2.5rem] shadow-2xl border border-white">
                                    <h2 className="text-xl font-black text-center mb-6 tracking-widest text-slate-800">ğŸ“Š å€‹äººç›ˆè™§è¡¨</h2>
                                    <div className="space-y-3">
                                        {Object.entries(report.balances).map(([name, amount]) => (
                                            <div key={name} className="flex justify-between items-center p-4 bg-slate-50 rounded-2xl">
                                                <span className="font-bold text-slate-600">{name}</span>
                                                <span className={`font-mono font-black ${amount >= 0 ? 'text-green-600' : 'text-red-500'}`}>
                                                    {amount >= 0 ? `+$${Math.round(amount)} (æ”¶)` : `-$${Math.abs(Math.round(amount))} (ä»˜)`}
                                                </span>
                                            </div>
                                        ))}
                                    </div>

                                    <div className="my-8 border-t border-dashed border-slate-200"></div>

                                    <h2 className="text-xl font-black text-center mb-6 tracking-widest text-slate-800">ğŸ’¸ æœ€çµ‚æ’¥æ¬¾è¡Œå‹•</h2>
                                    <div className="space-y-4">
                                        {report.plans.length === 0 ? (
                                            <p className="text-center text-slate-400 py-6">å¸³ç›®å®Œç¾æŠµéŠ·ï¼Œç„¡éœ€æ’¥æ¬¾ï¼</p>
                                        ) : (
                                            report.plans.map((p, i) => (
                                                <div key={i} className="bg-blue-50 p-5 rounded-2xl flex items-center justify-between border border-blue-100">
                                                    <div className="flex flex-col items-center flex-1">
                                                        <span className="text-[10px] font-black text-blue-400 uppercase mb-1">From</span>
                                                        <span className="font-black text-red-500">{p.from}</span>
                                                    </div>
                                                    <div className="flex flex-col items-center flex-1">
                                                        <span className="font-mono font-black text-xl text-blue-700 shadow-sm bg-white px-3 py-1 rounded-xl">${p.amount}</span>
                                                        <i data-lucide="arrow-right" className="w-4 h-4 text-blue-300 mt-1"></i>
                                                    </div>
                                                    <div className="flex flex-col items-center flex-1">
                                                        <span className="text-[10px] font-black text-blue-400 uppercase mb-1">To</span>
                                                        <span className="font-black text-green-600">{p.to}</span>
                                                    </div>
                                                </div>
                                            ))
                                        )}
                                    </div>
                                    
                                    <div className="mt-8 p-4 bg-slate-100 rounded-xl text-[10px] text-slate-400 italic">
                                        * è¨ˆç®—å‚™è¨»ï¼šé™¤ä¸ç›¡çš„å¾®å°é¤˜æ•¸å·²ç”±ä»˜æ¬¾äººè‡ªå‹•å¸æ”¶ï¼Œç¢ºä¿å¸³ç›®ç¸½é¡å¹³æ•´ã€‚
                                    </div>
                                </div>
                                <button onClick={() => window.location.reload()} className="w-full bg-slate-900 text-white py-5 rounded-3xl font-bold flex items-center justify-center gap-2 shadow-xl"><i data-lucide="rotate-ccw"></i> é‡æ–°é–‹å•Ÿæ–°çµç®—</button>
                            </div>
                        )}
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
