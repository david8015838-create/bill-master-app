<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>åˆ†å¸³å¤§å¸«</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f8fafc; }
        .step-gradient { background: linear-gradient(to tr, #2563eb, #4f46e5); }
    </style>
</head>
<body>
    <div id="root"></div>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="text/babel">
        const { useState, useMemo, useEffect } = React;

        const App = () => {
            const [step, setStep] = useState(1);
            const [participants, setParticipants] = useState([]);
            const [newName, setNewName] = useState('');
            const [expenses, setExpenses] = useState([]);

            // è‡ªå‹•è¼‰å…¥åœ–ç¤º
            useEffect(() => { lucide.createIcons(); }, [step, participants, expenses]);

            const addParticipant = () => {
                if (newName.trim()) {
                    setParticipants([...participants, { id: Date.now(), name: newName.trim() }]);
                    setNewName('');
                }
            };

            const calculateSettlement = () => {
                const balance = {};
                participants.forEach(p => balance[p.name] = 0);
                expenses.forEach(exp => {
                    const share = exp.amount / participants.length;
                    participants.forEach(p => {
                        if (p.name === exp.payer) balance[p.name] += (exp.amount - share);
                        else balance[p.name] -= share;
                    });
                });
                const debtors = [], creditors = [];
                Object.keys(balance).forEach(name => {
                    if (balance[name] > 0.1) creditors.push({ name, amount: balance[name] });
                    else if (balance[name] < -0.1) debtors.push({ name, amount: Math.abs(balance[name]) });
                });
                const results = [];
                let d = 0, c = 0;
                while (d < debtors.length && c < creditors.length) {
                    const pay = Math.min(debtors[d].amount, creditors[c].amount);
                    results.push({ from: debtors[d].name, to: creditors[c].name, amount: pay.toFixed(0) });
                    debtors[d].amount -= pay;
                    creditors[c].amount -= pay;
                    if (debtors[d].amount < 1) d++;
                    if (creditors[c].amount < 1) c++;
                }
                return results;
            };

            const settlementResults = useMemo(() => calculateSettlement(), [participants, expenses]);

            return (
                <div className="min-h-screen pb-20">
                    <header className="bg-white border-b sticky top-0 z-50 px-4 py-4 flex justify-between items-center shadow-sm">
                        <div className="flex items-center gap-2">
                            <div className="w-8 h-8 step-gradient rounded-lg flex items-center justify-center text-white font-bold text-xl">Â¥</div>
                            <h1 className="font-bold text-lg text-slate-800">åˆ†å¸³å¤§å¸«</h1>
                        </div>
                    </header>

                    <main className="max-w-md mx-auto p-6">
                        {step === 1 && (
                            <div className="space-y-6">
                                <h2 className="text-2xl font-bold text-slate-800">1. èª°åƒèˆ‡äº†æ´»å‹•ï¼Ÿ</h2>
                                <div className="flex gap-2">
                                    <input 
                                        value={newName} 
                                        onChange={e => setNewName(e.target.value)} 
                                        onKeyPress={e => e.key === 'Enter' && addParticipant()}
                                        placeholder="è¼¸å…¥å§“å..." 
                                        className="flex-1 border-2 border-slate-200 rounded-xl px-4 py-3 focus:border-blue-500 outline-none transition-all" 
                                    />
                                    <button onClick={addParticipant} className="bg-blue-600 text-white px-6 rounded-xl font-bold">æ–°å¢</button>
                                </div>
                                <div className="bg-white rounded-2xl border shadow-sm divide-y">
                                    {participants.length === 0 && <div className="p-8 text-center text-slate-400">ç›®å‰é‚„æ²’æœ‰äººå–”</div>}
                                    {participants.map(p => (
                                        <div key={p.id} className="p-4 flex justify-between items-center font-medium">
                                            <span>{p.name}</span>
                                            <button onClick={() => setParticipants(participants.filter(x => x.id !== p.id))} className="text-red-400 px-2">åˆªé™¤</button>
                                        </div>
                                    ))}
                                </div>
                                {participants.length >= 2 && (
                                    <button onClick={() => setStep(2)} className="w-full bg-blue-600 text-white py-4 rounded-2xl font-bold shadow-lg flex items-center justify-center gap-2">
                                        ä¸‹ä¸€æ­¥ï¼šè¼¸å…¥èŠ±è²»
                                    </button>
                                )}
                            </div>
                        )}

                        {step === 2 && (
                            <div className="space-y-6">
                                <h2 className="text-2xl font-bold text-slate-800">2. æ–°å¢æ”¯å‡º</h2>
                                <div className="bg-white p-6 rounded-2xl border-2 border-blue-100 shadow-sm space-y-4">
                                    <div>
                                        <label className="block text-sm font-bold text-slate-500 mb-1">é …ç›®åç¨±</label>
                                        <input id="expName" placeholder="ä¾‹å¦‚ï¼šæ™šé¤ã€è»Šè³‡" className="w-full border rounded-xl px-4 py-3" />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-bold text-slate-500 mb-1">é‡‘é¡</label>
                                        <input id="expAmount" type="number" placeholder="0" className="w-full border rounded-xl px-4 py-3" />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-bold text-slate-500 mb-1">èª°ä»˜éŒ¢çš„ï¼Ÿ</label>
                                        <select id="expPayer" className="w-full border rounded-xl px-4 py-3 bg-white">
                                            {participants.map(p => <option key={p.id} value={p.name}>{p.name}</option>)}
                                        </select>
                                    </div>
                                    <button onClick={() => {
                                        const n = document.getElementById('expName');
                                        const a = document.getElementById('expAmount');
                                        const p = document.getElementById('expPayer');
                                        if (n.value && a.value) {
                                            setExpenses([...expenses, { id: Date.now(), name: n.value, amount: parseFloat(a.value), payer: p.value }]);
                                            n.value = ''; a.value = '';
                                        }
                                    }} className="w-full bg-slate-800 text-white py-3 rounded-xl font-bold">+ æ–°å¢é€™ç­†è²»ç”¨</button>
                                </div>
                                <div className="space-y-2">
                                    {expenses.map(e => (
                                        <div key={e.id} className="bg-white p-4 rounded-xl border flex justify-between shadow-sm">
                                            <span><strong>{e.payer}</strong> ä»˜äº† {e.name}</span>
                                            <span className="font-bold text-blue-600">${e.amount}</span>
                                        </div>
                                    ))}
                                </div>
                                <div className="flex gap-3">
                                    <button onClick={() => setStep(1)} className="flex-1 bg-slate-200 py-4 rounded-2xl font-bold">è¿”å›</button>
                                    <button onClick={() => setStep(3)} className="flex-1 bg-blue-600 text-white py-4 rounded-2xl font-bold shadow-lg">çœ‹çµæœ</button>
                                </div>
                            </div>
                        )}

                        {step === 3 && (
                            <div className="space-y-6">
                                <h2 className="text-2xl font-bold text-slate-800">3. çµç®—æ¸…å–®</h2>
                                <div className="bg-white rounded-3xl border-2 border-green-100 p-8 space-y-6 shadow-sm">
                                    {settlementResults.length === 0 ? (
                                        <div className="text-center py-10">
                                            <div className="text-4xl mb-4">ğŸ‰
